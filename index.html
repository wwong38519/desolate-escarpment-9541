<!DOCTYPE html>
<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.0-rc.0/angular.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.0-rc.0/angular-route.js"></script>
<script>
var serialize = function(obj) {
	var str = [];
	for(var p in obj){
		if (obj.hasOwnProperty(p)) {
			str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
		}
	}
	return str.join("&");
}
var app = angular.module('facebook-app', ['ngRoute']);

app.config(['$routeProvider', function($routeProvider) {
	$routeProvider
	.when('/', {
		templateUrl: '/link.html'
	})
	.when('/page/:id', {
		templateUrl: '/page.html',
		controller: 'page-controller'
	})
	.otherwise({redirectTo: '/'});
}]);

app.factory('facebook', ['$http', function($http) {
	var fb = {};
	var init = false;
	fb.login = function() {
		return $http.get('/login').success(function(data) {
			init = true;
		});
	}
	fb.api = function(path, params, callback) {
		var options = {
			params: {
				path: path + '?' + serialize(params),
			}
		};
		if (!init) {
			setTimeout(function() {
				fb.api(path, params, callback);
			}, 100);
			return;
		}
		return $http.get('/api', options).success(function(data) {
			callback(JSON.parse(data));
		});
	};
	return fb;
}]);

app.controller('page-controller', ['$scope', '$routeParams', 'facebook', function($scope, $routeParams, facebook) {
	facebook.login();
	$scope.page_id = $routeParams.id;
	$scope.update = function() {
		$scope.ready = false;
		$scope.page = {};
		var path, params;
		path = '/'+$scope.page_id;
		params = {fields: 'name,about,likes,link'};
		facebook.api(path, params, function(data) {
			if ($scope.ready = !data.error) {
				$scope.page.info = data;
				path = '/'+$scope.page_id+'/posts'
				params = {fields: 'id,created_time,name,description,message,link,picture,shares,likes,status_type'};
				facebook.api(path, params, function(data) {
					$scope.page.posts = data.data;
				});
			}
		});
	};
}]);
</script>
</head>
<body data-ng-app="facebook-app">
<div ng-view></div>
<script id="/link.html" type="text/ng-template">
<a href="#/page/281498931927662">Gameover</a>
<a href="#/page/601482093198357">Sunnyhahaha</a>
<a href="#/page/228735667216">BBC News</a>
</script>
<script id="/page.html" type="text/ng-template">
<div ng-include="'/link.html'"></div>
<div>
	<input ng-hide="true" ng-model="page_id" ng-change="update()" ng-init="update()" placeholder="page id" />
	<div ng-if="ready">
		<div><a href="{{page.info.link}}">{{page.info.name}}</a> {{page.info.likes}} likes</div>
		<div>{{page.info.about}}</div>
		<div ng-repeat="post in page.posts">
			<hr/>
			<div><img ng-show="post.picture" src="{{post.picture}}"/></div>
			<div ng-show="post.status_type=='shared_story'">
				<blockquote>
					<a href="{{post.link}}">{{post.name}}</a>
					<div>{{post.description}}</div>
				</blockquote>
			</div>
			<div>{{post.message}}</div>
			<div>{{post.shares.count || 0}} shares {{post.likes.data.length}} likes {{post.created_time}}</div>
		</div>
	</div>
</div>
</script>
</body>
</html>

