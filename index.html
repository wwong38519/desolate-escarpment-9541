<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- bower:js -->
<script src="bower_components/angular/angular.js"></script>
<script src="bower_components/angular-route/angular-route.js"></script>
<!-- endbower -->
<!-- bower:css -->
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
<!-- endbower -->
<script>
var serialize = function(obj) {
	var str = [];
	for(var p in obj){
		if (obj.hasOwnProperty(p)) {
			str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
		}
	}
	return str.join("&");
}
var app = angular.module('facebook-app', ['ngRoute']);

app.config(['$routeProvider', function($routeProvider) {
	$routeProvider
	.when('/', {
		templateUrl: '/link.html'
	})
	.when('/page/:id', {
		templateUrl: '/page.html',
		controller: 'page-controller'
	})
	.otherwise({redirectTo: '/'});
}]);

app.factory('facebook', ['$http', function($http) {
	var fb = {};
	var init = false;
	fb.login = function() {
		return $http.get('/login').success(function(data) {
			init = true;
		});
	}
	fb.api = function(path, params, callback) {
		var options = {
			params: {
				path: path + '?' + serialize(params),
			}
		};
		if (!init) {
			setTimeout(function() {
				fb.api(path, params, callback);
			}, 100);
			return;
		}
		return $http.get('/api', options).success(function(data) {
			callback(JSON.parse(data));
		});
	};
	return fb;
}]);

app.controller('page-controller', ['$scope', '$routeParams', 'facebook', function($scope, $routeParams, facebook) {
	facebook.login();
	$scope.page_id = $routeParams.id;
	$scope.update = function() {
		$scope.ready = false;
		$scope.page = {};
		var path, params;
		path = '/'+$scope.page_id;
		params = {fields: 'name,about,likes,link'};
		facebook.api(path, params, function(data) {
			if ($scope.ready = !data.error) {
				$scope.page.info = data;
				path = '/'+$scope.page_id+'/posts'
				params = {fields: 'id,created_time,name,description,message,link,picture,shares,likes,status_type'};
				facebook.api(path, params, function(data) {
					$scope.page.posts = data.data;
				});
			}
		});
	};
}]);
</script>
</head>
<body data-ng-app="facebook-app">
<div ng-view></div>
<script id="/link.html" type="text/ng-template">
<a href="#/page/281498931927662">Gameover</a>
<a href="#/page/unwirehk">UNWIRE.HK</a>
<a href="#/page/601482093198357">Sunnyhahaha</a>
<a href="#/page/228735667216">BBC News</a>
<a href="#/page/theguardian">The Guardian</a>
<a href="#/page/theeconomist">The Economist</a>
<a href="#/page/huffingtonpost">Huffington Post</a>
</script>
<script id="/page.html" type="text/ng-template">
<div ng-include="'/link.html'"></div>
<div class="container-fluid">
	<input ng-hide="true" ng-model="page_id" ng-change="update()" ng-init="update()" placeholder="page id" />
	<div ng-if="ready">
		<div class="title">
			<h5><a href="{{page.info.link}}" target="_blank">{{page.info.name}}</a> {{page.info.likes}} likes</h5>
			<p>{{page.info.about}}</p>
		</div>
		<div class="row" ng-repeat="post in page.posts">
			<div class="col-md-10">
				<div>{{post.message}}</div>
				<div ng-show="post.status_type=='shared_story'">
					<blockquote>
						<a href="{{post.link}}" target="_blank">{{post.name}}</a>
						<p>{{post.description}}</p>
					</blockquote>
				</div>
				<small>{{post.shares.count || 0}} shares {{post.likes.data.length}} likes {{post.created_time | date:'yyyy-MM-dd HH:mm:ss'}}</small>
			</div>
			<div class="col-md-2 hidden-sm hidden-xs"><img ng-show="post.picture" ng-src="{{post.picture}}"/></div>
		</div>
	</div>
</div>
<style>
.row:nth-of-type(even) {background:#ebebeb;}
blockquote{font-size:14px;}
</style>
</script>
</body>
</html>

